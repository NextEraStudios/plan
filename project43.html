<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project 43</title>
    
    <style>
        :root {
            --bg-color: #fbfbfd;
            --card-bg: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --accent: #0071e3;
            --divider: #d2d2d7;
            --glass: rgba(255, 255, 255, 0.85);
            --shadow-lg: 0 12px 30px rgba(0,0,0,0.06);
            --radius: 20px;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: var(--font-stack);
            margin: 0;
            padding-bottom: 80px;
            overflow-x: hidden;
        }

        /* --- Header --- */
        header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: var(--glass);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 16px 0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 24px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        h1 { font-size: 22px; font-weight: 600; margin: 0; }
        
        .days-left {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            background: rgba(0,0,0,0.05);
            padding: 4px 10px;
            border-radius: 12px;
        }

        /* --- Progress Bar --- */
        .progress-track {
            width: 100%;
            height: 6px;
            background: rgba(0,0,0,0.06);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #1d1d1f;
            width: 0%;
            transition: width 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* --- Date Scroller --- */
        .date-scroller {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 12px 24px;
            scrollbar-width: none;
            margin-top: 5px;
            scroll-behavior: smooth;
            border-bottom: 1px solid rgba(0,0,0,0.03);
        }
        .date-scroller::-webkit-scrollbar { display: none; }

        .date-chip {
            min-width: 65px;
            padding: 10px 0;
            border-radius: 12px;
            background: white;
            color: var(--text-secondary);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            font-weight: 500;
            flex-shrink: 0;
            user-select: none;
        }

        .date-chip span {
            display: block;
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 2px;
        }

        .date-chip.active {
            background: var(--text-primary);
            color: rgba(255,255,255,0.8);
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .date-chip.active span { color: white; }
        .date-chip.rest-day-marker { color: #34c759; } 

        /* --- Main Content --- */
        main { padding-top: 30px; }

        .hero-section {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeIn 0.8s ease;
        }
        .hero-section h2 { font-size: 34px; margin: 0 0 8px 0; letter-spacing: -0.02em; }
        .hero-section p { font-size: 17px; color: var(--text-secondary); margin: 0; }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 30px;
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Rest Day Styles --- */
        .rest-mode {
            text-align: center;
            padding: 60px 20px;
            background: linear-gradient(135deg, #e0f7fa 0%, #ffffff 100%);
        }
        .rest-icon { font-size: 40px; margin-bottom: 20px; display: block; }
        .rest-title { font-size: 28px; font-weight: 700; color: #007d91; margin-bottom: 10px; }
        .rest-desc { color: #5a7d85; font-size: 18px; line-height: 1.5; }

        /* --- List Styles --- */
        .subject-row { margin-bottom: 25px; }
        .subject-row:last-child { margin-bottom: 0; }
        
        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--divider);
        }
        
        .sub-name { font-size: 20px; font-weight: 600; }
        .paper-tag {
            background: #000;
            color: #fff;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .checklist-item:hover { opacity: 0.8; }

        .checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid #d2d2d7;
            border-radius: 50%;
            margin-right: 15px;
            position: relative;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .checklist-item.checked .checkbox {
            background: var(--accent);
            border-color: var(--accent);
            transform: scale(1.1);
        }

        .checklist-item.checked .checkbox::after {
            content: '';
            position: absolute;
            top: 5px; left: 4px; width: 10px; height: 5px;
            border-left: 2px solid white; border-bottom: 2px solid white;
            transform: rotate(-45deg);
        }

        .checklist-item.checked .text {
            color: var(--text-secondary);
            text-decoration: line-through;
        }
        
        .text { font-size: 16px; line-height: 1.4; color: var(--text-primary); transition: color 0.2s; }

        /* --- Footer --- */
        .firebase-status {
            text-align: center;
            font-size: 12px;
            color: #ccc;
            padding-top: 20px;
        }
    </style>
</head>
<body>

<header>
    <div class="container">
        <div class="top-bar">
            <h1>Project 43</h1>
            <div class="days-left" id="daysLeftDisplay">Loading...</div>
        </div>
        <div class="progress-track">
            <div class="progress-fill" id="overallProgressBar"></div>
        </div>
    </div>
    <div class="date-scroller" id="dateScroller"></div>
</header>

<main class="container">
    <div class="hero-section">
        <h2 id="currentDateTitle">Today</h2>
        <p id="currentFocusSubtitle">Focus.</p>
    </div>

    <div id="scheduleContent"></div>
    <div class="firebase-status" id="dbStatus">Syncing with cloud...</div>
</main>

<!-- Firebase SDK -->
<!-- Firebase SDK -->
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyALPWZE3MlEjy0qhhGl_V8WZxBJyA3Vo68",
    authDomain: "mockexams-f756d.firebaseapp.com",
    projectId: "mockexams-f756d",
    storageBucket: "mockexams-f756d.firebasestorage.app",
    messagingSenderId: "330440451161",
    appId: "1:330440451161:web:69331f774c4db8ef0c3d48",
    measurementId: "G-ERY7L5MJ5N"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
<script>
    // --- State & User ---
    let userId = localStorage.getItem('p43_user_id');
    if (!userId) {
        userId = 'student_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('p43_user_id', userId);
    }
    
    let completedItems = {}; 
    let selectedDayIndex = 0;
    const mockStartDate = new Date("2026-02-24");

    // --- Syllabus Content (Kept same as your code) ---
    const syllabus = {
        maths: [ "Algebra & Functions", "Coordinate Geometry", "Exponentials & Logs", "Binomial Expansion", "Sequences & Series", "Trigonometry", "Differentiation", "Integration", "Data Measures", "Probability", "Correlation" ],
        physics: [ "Motion & Graphs", "Energy & Momentum", "Fluids & Solids", "Waves Basics", "Light & Sound", "Circuits & Current", "Resistance & EMF", "Practical Skills" ],
        biology: [ "Chemistry of Life", "Mammalian Transport", "CVD Health", "Membranes", "Proteins & DNA", "Genetics", "Stem Cells", "Practical Bio" ],
        chemistry: [ "Formulae & Moles", "Atomic Structure", "Bonding", "Intro to Organic", "Alkenes", "Energetics", "Intermolecular Forces", "Redox & Groups", "Kinetics", "Alcohols" ]
    };

    // --- Past Paper Rotation ---
    const pastPaperSchedule = [
        { papers: ["Maths P2", "Physics U1", "Chemistry U1"] },
        { papers: ["Biology U1", "Physics U2", "HPAT"] },
        { papers: ["Chemistry U2", "Biology U2", "Physics U3"] },
        { papers: ["Maths P2", "Chemistry U3", "Biology U3"] },
        { papers: ["Physics U1", "Chemistry U1", "Biology U1"] },
        { papers: ["Maths S1", "Physics U2", "Chemistry U2"] },
        { papers: ["Biology U2", "Physics U3", "Maths P2"] },
        { papers: ["Chemistry U3", "Biology U3", "Physics U1"] },
        { papers: ["Maths S1", "Biology U1", "Chemistry U1"] } 
    ];

    // --- Schedule Generator ---
    const schedule = [];
    const startDate = new Date("2026-01-12");
    let mIdx=0, pIdx=0, bIdx=0, cIdx=0;

    for (let i = 0; i < 43; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        
        const dayOfMonth = currentDate.getDate();
        const month = currentDate.toLocaleString('default', { month: 'short' });
        
        let dayData = {
            id: i,
            dateObj: currentDate,
            displayDate: { month, day: dayOfMonth, name: currentDate.toLocaleString('default', { weekday: 'short' }) },
            type: 'revision', 
            subjects: []
        };

        if (i === 42) { 
            dayData.type = 'rest';
        } else if (i >= 33) {
            dayData.type = 'exam';
            const paperSet = pastPaperSchedule[i - 33];
            paperSet.papers.forEach(paperName => {
                dayData.subjects.push({
                    title: paperName,
                    tag: "PAST PAPER",
                    tasks: ["Complete paper (Timed)", "Mark strictly", "Review errors"]
                });
            });
        } else {
            if (i % 2 === 0) {
                dayData.subjects.push({ title: "Mathematics", tag: "P2 / S1", tasks: [`Topic: ${syllabus.maths[mIdx % syllabus.maths.length]}`, "Exam Qs", "Formulas"] });
                dayData.subjects.push({ title: "Physics", tag: "IAL Unit 1/2/3", tasks: [`Topic: ${syllabus.physics[pIdx % syllabus.physics.length]}`, "Definitions", "Calculations"] });
                if(i < 30) { mIdx++; pIdx++; }
            } else {
                dayData.subjects.push({ title: "Biology", tag: "IAL Unit 1/2/3", tasks: [`Topic: ${syllabus.biology[bIdx % syllabus.biology.length]}`, "Active Recall", "Diagrams"] });
                dayData.subjects.push({ title: "Chemistry", tag: "IAL Unit 1/2/3", tasks: [`Topic: ${syllabus.chemistry[cIdx % syllabus.chemistry.length]}`, "Mechanisms", "Definitions"] });
                if(i < 30) { bIdx++; cIdx++; }
            }
        }
        schedule.push(dayData);
    }

    // --- UI Functions ---
    function calculateStats() {
        const today = new Date();
        const diff = Math.ceil((mockStartDate - today) / (1000 * 60 * 60 * 24));
        document.getElementById('daysLeftDisplay').textContent = `${Math.max(0, diff)} Days to Mocks`;

        let totalTasks = 0;
        let doneTasks = 0;
        
        schedule.forEach(day => {
            if (day.type === 'rest') return;
            day.subjects.forEach((sub, sIdx) => {
                sub.tasks.forEach((_, tIdx) => {
                    totalTasks++;
                    if (completedItems[`d${day.id}_s${sIdx}_t${tIdx}`]) doneTasks++;
                });
            });
        });

        const pct = totalTasks === 0 ? 0 : (doneTasks / totalTasks) * 100;
        document.getElementById('overallProgressBar').style.width = `${pct}%`;
    }

    function renderScroller() {
        const scroller = document.getElementById('dateScroller');
        scroller.innerHTML = '';
        
        const todayStr = new Date().toDateString();
        const todayIdx = schedule.findIndex(d => d.dateObj.toDateString() === todayStr);
        if (selectedDayIndex === 0 && todayIdx !== -1) selectedDayIndex = todayIdx;

        schedule.forEach((day, idx) => {
            const el = document.createElement('div');
            el.className = `date-chip ${idx === selectedDayIndex ? 'active' : ''} ${day.type === 'rest' ? 'rest-day-marker' : ''}`;
            el.innerHTML = `${day.displayDate.month} ${day.displayDate.day}<span>${day.displayDate.name}</span>`;
            el.onclick = () => {
                document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
                el.classList.add('active');
                selectedDayIndex = idx;
                renderDay(idx);
                el.scrollIntoView({ behavior: 'smooth', inline: 'center' });
            };
            scroller.appendChild(el);
        });
        
        setTimeout(() => {
            const active = document.querySelector('.date-chip.active');
            if(active) active.scrollIntoView({ inline: 'center' });
        }, 100);
    }

    function renderDay(idx) {
        const day = schedule[idx];
        const container = document.getElementById('scheduleContent');
        container.innerHTML = '';

        const title = document.getElementById('currentDateTitle');
        const subtitle = document.getElementById('currentFocusSubtitle');
        
        const isToday = day.dateObj.toDateString() === new Date().toDateString();
        title.textContent = isToday ? "Today" : `${day.displayDate.name}, ${day.displayDate.month} ${day.displayDate.day}`;

        if (day.type === 'rest') {
            subtitle.textContent = "Recharge your mind.";
            container.innerHTML = `<div class="card rest-mode"><span class="rest-icon">ðŸ§˜</span><div class="rest-title">Rest Day</div><div class="rest-desc">No studying today.</div></div>`;
            return;
        }

        subtitle.textContent = day.type === 'exam' ? "Past Paper Mode." : "Deep Focus Revision.";

        const card = document.createElement('div');
        card.className = 'card';
        
        day.subjects.forEach((sub, sIdx) => {
            const row = document.createElement('div');
            row.className = 'subject-row';
            let html = `<div class="subject-header"><div class="sub-name">${sub.title}</div><span class="paper-tag" style="background:${day.type==='exam' ? '#FF2D55' : '#000'}">${sub.tag}</span></div>`;

            sub.tasks.forEach((task, tIdx) => {
                const itemId = `d${day.id}_s${sIdx}_t${tIdx}`;
                const checked = completedItems[itemId] ? 'checked' : '';
                html += `<div class="checklist-item ${checked}" id="${itemId}" onclick="window.toggle('${itemId}')"><div class="checkbox"></div><div class="text">${task}</div></div>`;
            });

            row.innerHTML = html;
            card.appendChild(row);
        });
        container.appendChild(card);
    }

    // --- Actions ---
    window.toggle = (id) => {
        // 1. Optimistic UI update (Immediate)
        const isChecked = !completedItems[id];
        completedItems[id] = isChecked;
        
        const el = document.getElementById(id);
        if(el) {
            if(isChecked) el.classList.add('checked');
            else el.classList.remove('checked');
        }
        calculateStats();
        
        // 2. Set Status immediately to "Saving"
        const statusEl = document.getElementById('dbStatus');
        statusEl.textContent = "Saving...";
        statusEl.style.color = "#86868b";

        // 3. Fire and forget (don't await)
        const docRef = doc(db, "users", userId);
        setDoc(docRef, { progress: completedItems }, { merge: true });
    };

    // --- Init ---
    async function init() {
        renderScroller();
        renderDay(selectedDayIndex);
        calculateStats();

        const docRef = doc(db, "users", userId);
        
        // Listen with metadata to distinguish local vs server events
        onSnapshot(docRef, (snap) => {
            const source = snap.metadata.hasPendingWrites ? "Local" : "Server";
            
            if (snap.exists()) {
                completedItems = snap.data().progress || {};
                
                // Only re-render if it's a server update to prevent UI jitter
                // or if we just loaded for the first time
                renderDay(selectedDayIndex); 
                calculateStats();
                
                const statusEl = document.getElementById('dbStatus');
                if (source === "Local") {
                    statusEl.textContent = "Unsynced changes...";
                } else {
                    statusEl.textContent = "All changes saved";
                    statusEl.style.color = "#34c759";
                }
            }
        });
    }

    init();
</script>
</body>
</html>


