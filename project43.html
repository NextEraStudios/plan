<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project 43</title>
    
    <!-- Design System: Apple Aesthetics -->
    <style>
        :root {
            --bg-color: #fbfbfd;
            --card-bg: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --accent: #0071e3; /* Apple Blue */
            --accent-hover: #0077ed;
            --divider: #d2d2d7;
            --success: #34c759;
            --glass: rgba(255, 255, 255, 0.8);
            --shadow-sm: 0 4px 6px rgba(0,0,0,0.02);
            --shadow-lg: 0 20px 40px rgba(0,0,0,0.06);
            --radius: 20px;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: var(--font-stack);
            margin: 0;
            padding-bottom: 60px;
            overflow-x: hidden;
        }

        /* --- Header & Progress --- */
        header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: var(--glass);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 16px 0;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 980px;
            margin: 0 auto;
            padding: 0 24px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            letter-spacing: -0.02em;
        }

        .days-left {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .progress-container {
            width: 100%;
            height: 6px;
            background: rgba(0,0,0,0.05);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--text-primary);
            width: 0%;
            transition: width 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* --- Date Scroller --- */
        .date-scroller {
            display: flex;
            overflow-x: auto;
            gap: 12px;
            padding: 12px 24px;
            scrollbar-width: none; /* Firefox */
            margin-top: 10px;
            scroll-behavior: smooth;
        }
        .date-scroller::-webkit-scrollbar { display: none; }

        .date-chip {
            min-width: 70px;
            padding: 12px 0;
            border-radius: 14px;
            background: white;
            color: var(--text-secondary);
            text-align: center;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            font-size: 13px;
            font-weight: 500;
            flex-shrink: 0;
        }

        .date-chip span {
            display: block;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 2px;
        }

        .date-chip.active {
            background: var(--text-primary);
            color: rgba(255,255,255,0.8);
        }
        .date-chip.active span { color: white; }
        .date-chip:hover:not(.active) { transform: scale(1.02); background: #f5f5f7; }

        /* --- Main Content --- */
        main {
            padding-top: 40px;
            min-height: 60vh;
        }

        .hero-text {
            text-align: center;
            margin-bottom: 40px;
        }
        .hero-text h2 {
            font-size: 40px;
            font-weight: 700;
            letter-spacing: -0.03em;
            margin: 0 0 10px 0;
        }
        .hero-text p {
            font-size: 19px;
            color: var(--text-secondary);
            line-height: 1.4;
            max-width: 600px;
            margin: 0 auto;
        }

        .schedule-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 40px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 40px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeUp {
            to { opacity: 1; transform: translateY(0); }
        }

        .subject-group {
            margin-bottom: 40px;
        }
        .subject-group:last-child { margin-bottom: 0; }

        .subject-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--divider);
            padding-bottom: 12px;
        }

        .subject-title {
            font-size: 24px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }
        
        .subject-title .unit-badge {
            font-size: 14px;
            background: #f5f5f7;
            color: var(--text-secondary);
            padding: 4px 10px;
            border-radius: 20px;
            margin-left: 10px;
            vertical-align: middle;
            font-weight: 500;
        }

        .time-est {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* --- Checklist --- */
        .checklist-item {
            display: flex;
            align-items: flex-start;
            padding: 12px 0;
            cursor: pointer;
            group;
        }

        .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #d1d1d6;
            border-radius: 50%;
            margin-right: 16px;
            flex-shrink: 0;
            position: relative;
            transition: all 0.3s ease;
        }

        .checklist-item.checked .checkbox {
            background: var(--accent);
            border-color: var(--accent);
        }

        .checklist-item.checked .checkbox::after {
            content: '';
            position: absolute;
            top: 6px;
            left: 5px;
            width: 10px;
            height: 5px;
            border-left: 2px solid white;
            border-bottom: 2px solid white;
            transform: rotate(-45deg);
        }

        .item-text {
            font-size: 17px;
            line-height: 1.5;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .checklist-item.checked .item-text {
            color: var(--text-secondary);
            text-decoration: line-through;
        }

        /* --- Past Paper Mode Styles --- */
        .past-paper-mode .subject-title { color: var(--text-primary); }
        .past-paper-badge {
            background: #FF2D55; /* Apple Pink */
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 20px;
            display: inline-block;
        }

        /* --- Mobile Responsive --- */
        @media (max-width: 768px) {
            .hero-text h2 { font-size: 32px; }
            .schedule-card { padding: 24px; }
            .subject-title { font-size: 20px; }
            .item-text { font-size: 16px; }
        }
    </style>
</head>
<body>

<header>
    <div class="container">
        <div class="top-bar">
            <h1>Project 43</h1>
            <div class="days-left" id="daysLeftDisplay">Loading...</div>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="overallProgressBar"></div>
        </div>
    </div>
    <div class="date-scroller" id="dateScroller">
        <!-- JS will populate dates -->
    </div>
</header>

<main class="container">
    <div class="hero-text">
        <h2 id="currentDateTitle">Today</h2>
        <p id="currentFocusSubtitle">Focus on the process.</p>
    </div>

    <div id="scheduleContent">
        <!-- JS will populate daily cards -->
    </div>
</main>

<!-- Firebase Logic & App Logic -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyALPWZE3MlEjy0qhhGl_V8WZxBJyA3Vo68",
        authDomain: "mockexams-f756d.firebaseapp.com",
        projectId: "mockexams-f756d",
        storageBucket: "mockexams-f756d.firebasestorage.app",
        messagingSenderId: "330440451161",
        appId: "1:330440451161:web:69331f774c4db8ef0c3d48",
        measurementId: "G-ERY7L5MJ5N"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- User Identification ---
    // Simple local storage ID to simulate user session without full auth login screen
    let userId = localStorage.getItem('p43_user_id');
    if (!userId) {
        userId = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('p43_user_id', userId);
    }

    // --- Syllabus Data (Extracted from Images) ---
    const syllabus = {
        maths: [
            "P2: Ch1 Algebraic Methods", "P2: Ch2 Coordinate Geometry", "P2: Ch3 Exponentials & Logarithms", "P2: Ch4 Binomial Expansion",
            "P2: Ch5 Sequences & Series", "P2: Ch6 Trig Identities", "P2: Ch7 Differentiation", "P2: Ch8 Integration",
            "S1: Ch1 Math Modelling", "S1: Ch2 Measures of Location", "S1: Ch3 Representations of Data", "S1: Ch4 Probability",
            "S1: Ch5 Correlation & Regression"
        ],
        physics: [
            "U1: Topic 1 Mechanics (Motion)", "U1: Topic 1 Mechanics (Energy/Mom)", "U1: Topic 2 Materials (Fluids)", "U1: Topic 2 Materials (Solids)",
            "U2: Topic 3 Waves (Basic)", "U2: Topic 3 Waves (Behaviour/Light)", "U2: Topic 4 Electricity (Circuits)", "U2: Topic 4 Electricity (Resistance)",
            "U3: Practical Skills Review (Units/Errors)", "U3: Experimental Methods (Mech/Elec)"
        ],
        biology: [
            "U1: 1A Chemistry for Biologists", "U1: 1B Mammalian Transport", "U1: 1C Cardiovascular Health",
            "U2: 2A Membranes & Transport", "U2: 2B Proteins & DNA", "U2: 2C Gene Expression & Genetics",
            "U3: Practical Biology Skills", "U3: Core Practicals Review"
        ],
        chemistry: [
            "U1: Topic 1 Formulae & Equations", "U1: Topic 2 Atomic Structure", "U1: Topic 3 Bonding", "U1: Topic 4 Intro to Organic", "U1: Topic 5 Alkenes",
            "U2: Topic 6 Energetics", "U2: Topic 7 Intermolecular Forces", "U2: Topic 8 Redox & Groups 1,2,7", "U2: Topic 9 Kinetics/Equilibria", "U2: Topic 10 Organic (Alcohols/Spectra)",
            "U3: Practical Chemistry Skills"
        ]
    };

    // --- Schedule Generation ---
    const startDate = new Date("2026-01-12");
    const mockDate = new Date("2026-02-24");
    const pastPaperStartDate = new Date("2026-02-14");
    
    // Helper to format dates
    const formatDate = (d) => {
        const months = ["Jan", "Feb", "Mar"];
        const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        return {
            dayName: days[d.getDay()],
            dayNum: d.getDate(),
            month: months[d.getMonth()],
            full: d.toISOString().split('T')[0]
        };
    };

    // Generate 43 Days
    const schedule = [];
    const totalDays = 43;

    // Iterators for syllabus content
    let mIdx = 0, pIdx = 0, bIdx = 0, cIdx = 0;

    for (let i = 0; i < totalDays; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        const fDate = formatDate(currentDate);
        
        const isPastPaperPhase = currentDate >= pastPaperStartDate;
        
        let subjects = [];

        if (isPastPaperPhase) {
            // Last 10 days: Past Papers
            subjects = [
                { name: "Past Paper Session 1", unit: "Mixed", items: ["Complete full paper under timed conditions", "Mark paper strictly", "Review mistakes"] },
                { name: "Past Paper Session 2", unit: "Mixed", items: ["Complete full paper under timed conditions", "Mark paper strictly", "Review mistakes"] },
                { name: "Past Paper Session 3", unit: "Mixed", items: ["Complete full paper under timed conditions", "Mark paper strictly", "Review mistakes"] }
            ];
        } else {
            // Study Phase: Alternating Days
            // Even days (0, 2...): Maths & Physics
            // Odd days (1, 3...): Biology & Chemistry
            
            if (i % 2 === 0) {
                // Maths & Physics
                const mTopic = syllabus.maths[mIdx % syllabus.maths.length];
                const pTopic = syllabus.physics[pIdx % syllabus.physics.length];
                
                // Advance indices slowly to cover everything by Feb 13 (approx 32 days / 2 = 16 slots)
                // We have ~13 Maths topics and ~10 Phys topics. 
                if(i < 32) { mIdx++; pIdx++; }

                subjects.push({
                    name: "Mathematics",
                    unit: mTopic.split(':')[0],
                    items: [`Topic Questions: ${mTopic.split(':')[1]}`, "Review hard concepts", "Update formula sheet"]
                });
                subjects.push({
                    name: "Physics",
                    unit: pTopic.split(':')[0],
                    items: [`Topic Questions: ${pTopic.split(':')[1]}`, "Review definitions", "Practice calculation layout"]
                });

            } else {
                // Bio & Chem
                const bTopic = syllabus.biology[bIdx % syllabus.biology.length];
                const cTopic = syllabus.chemistry[cIdx % syllabus.chemistry.length];
                
                if(i < 32) { bIdx++; cIdx++; }

                subjects.push({
                    name: "Biology",
                    unit: bTopic.split(':')[0],
                    items: [`Topic Questions: ${bTopic.split(':')[1]}`, "Active Recall / Flashcards", "Draw diagrams from memory"]
                });
                subjects.push({
                    name: "Chemistry",
                    unit: cTopic.split(':')[0],
                    items: [`Topic Questions: ${cTopic.split(':')[1]}`, "Write out mechanisms", "Check standard definitions"]
                });
            }
        }

        schedule.push({
            id: i,
            dateObj: currentDate,
            dateStr: fDate,
            subjects: subjects,
            isExam: isPastPaperPhase
        });
    }

    // --- Application State ---
    let completedItems = {}; // Stored in Firebase: { "day_0_sub_0_item_0": true }
    let selectedDayIndex = 0;

    // --- DOM Elements ---
    const scroller = document.getElementById('dateScroller');
    const scheduleContent = document.getElementById('scheduleContent');
    const overallProgressBar = document.getElementById('overallProgressBar');
    const daysLeftDisplay = document.getElementById('daysLeftDisplay');

    // --- Functions ---

    function calculateDaysLeft() {
        const today = new Date();
        const diffTime = Math.abs(mockDate - today);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        daysLeftDisplay.textContent = `${diffDays} Days until Mocks`;
    }

    function calculateProgress() {
        const totalItems = schedule.reduce((acc, day) => {
            return acc + day.subjects.reduce((sAcc, sub) => sAcc + sub.items.length, 0);
        }, 0);
        
        const doneCount = Object.keys(completedItems).filter(k => completedItems[k]).length;
        const percentage = Math.min(100, (doneCount / totalItems) * 100);
        
        overallProgressBar.style.width = `${percentage}%`;
    }

    function renderDateScroller() {
        scroller.innerHTML = '';
        
        // Find today's index
        const todayString = new Date().toISOString().split('T')[0];
        const todayIndex = schedule.findIndex(d => d.dateObj.toISOString().split('T')[0] === todayString);
        
        // Default to Day 0 if before start, or today index
        selectedDayIndex = todayIndex >= 0 ? todayIndex : 0;
        if(todayIndex === -1 && new Date() > mockDate) selectedDayIndex = totalDays - 1;

        schedule.forEach((day, index) => {
            const chip = document.createElement('div');
            chip.className = `date-chip ${index === selectedDayIndex ? 'active' : ''}`;
            chip.innerHTML = `${day.dateStr.month} ${day.dateStr.dayNum}<span>Day ${index + 1}</span>`;
            chip.onclick = () => {
                document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                selectedDayIndex = index;
                renderSchedule(index);
                // Center selected
                chip.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            };
            scroller.appendChild(chip);
        });

        // Initial scroll to today
        setTimeout(() => {
            const active = document.querySelector('.date-chip.active');
            if(active) active.scrollIntoView({ behavior: 'auto', inline: 'center' });
        }, 100);
    }

    function toggleItem(id) {
        const currentState = completedItems[id] || false;
        const newState = !currentState;
        
        // Optimistic UI Update
        completedItems[id] = newState;
        document.getElementById(id).classList.toggle('checked', newState);
        calculateProgress();

        // Sync to Firebase
        const userRef = doc(db, "students", userId);
        setDoc(userRef, { progress: completedItems }, { merge: true });
    }

    window.handleToggle = toggleItem; // Expose to global scope for HTML onclick

    function renderSchedule(dayIndex) {
        const day = schedule[dayIndex];
        
        // Update Headers
        document.getElementById('currentDateTitle').textContent = 
            (day.dateObj.toDateString() === new Date().toDateString()) ? "Today" : `${day.dateStr.dayName}, ${day.dateStr.month} ${day.dateStr.dayNum}`;
            
        document.getElementById('currentFocusSubtitle').textContent = 
            day.isExam ? "Full Past Paper Mode. Simulate exam conditions." : "Deep work. 2 hours per subject.";

        scheduleContent.innerHTML = '';

        if(day.isExam) {
            const badge = document.createElement('div');
            badge.style.textAlign = 'center';
            badge.innerHTML = '<span class="past-paper-badge">Mock Exam Simulation</span>';
            scheduleContent.appendChild(badge);
        }

        day.subjects.forEach((sub, sIdx) => {
            const card = document.createElement('div');
            card.className = `schedule-card ${day.isExam ? 'past-paper-mode' : ''}`;
            
            let html = `
                <div class="subject-header">
                    <div class="subject-title">
                        ${sub.name} 
                        ${!day.isExam ? `<span class="unit-badge">${sub.unit}</span>` : ''}
                    </div>
                    <div class="time-est">2h 00m</div>
                </div>
            `;

            sub.items.forEach((item, iIdx) => {
                const itemId = `day_${dayIndex}_sub_${sIdx}_item_${iIdx}`;
                const isChecked = completedItems[itemId] ? 'checked' : '';
                
                html += `
                    <div class="checklist-item ${isChecked}" id="${itemId}" onclick="window.handleToggle('${itemId}')">
                        <div class="checkbox"></div>
                        <div class="item-text">${item}</div>
                    </div>
                `;
            });

            card.innerHTML = html;
            scheduleContent.appendChild(card);
        });
    }

    // --- Initialization ---
    async function init() {
        calculateDaysLeft();
        
        // Listen to Firebase Realtime Updates
        const userRef = doc(db, "students", userId);
        
        // Try getting initial doc, if not exists, create empty
        try {
            const docSnap = await getDoc(userRef);
            if(docSnap.exists()) {
                completedItems = docSnap.data().progress || {};
            }
        } catch(e) {
            console.log("Offline or first load", e);
        }

        renderDateScroller();
        renderSchedule(selectedDayIndex);
        calculateProgress();

        // Subscribe to changes (Sync across tabs/devices)
        onSnapshot(userRef, (doc) => {
            if (doc.exists()) {
                completedItems = doc.data().progress || {};
                // Only re-render checkmarks to avoid jitter, don't full re-render
                Object.keys(completedItems).forEach(key => {
                    const el = document.getElementById(key);
                    if(el) {
                        if(completedItems[key]) el.classList.add('checked');
                        else el.classList.remove('checked');
                    }
                });
                calculateProgress();
            }
        });
    }

    init();

</script>
</body>
</html>