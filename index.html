<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>A-Level & EPQ Planner</title>
    <style>
        :root {
            --bg-color: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --accent-blue: #007AFF;
            --bio-color: #34C759;
            --chem-color: #FF9500;
            --phys-color: #5856D6;
            --math-color: #FF2D55;
            --epq-color: #9C27B0; /* Added Purple for EPQ */
            --border-radius: 16px;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            padding-bottom: 40px;
            color: var(--text-primary);
            -webkit-tap-highlight-color: transparent;
        }

        /* Safe Area for iPhone Notch */
        header {
            background: var(--card-bg);
            padding: max(20px, env(safe-area-inset-top)) 20px 20px;
            border-bottom: 1px solid #E5E5EA;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 22px; font-weight: 700; }
        .overall-progress { font-size: 14px; color: var(--text-secondary); font-weight: 500; }
        .sync-status { font-size: 10px; color: var(--accent-blue); margin-top: 4px; }

        /* Date Navigation */
        .date-nav {
            display: flex;
            overflow-x: auto;
            padding: 15px 20px;
            gap: 10px;
            scrollbar-width: none; /* Firefox */
        }
        .date-nav::-webkit-scrollbar { display: none; }

        .date-pill {
            background: var(--card-bg);
            min-width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .date-pill.active {
            border-color: var(--accent-blue);
            background: #EBF3FF;
        }
        
        .date-pill.completed {
            background: #E8F5E9; /* Light green background for completed days */
        }

        .date-pill span:first-child { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; }
        .date-pill span:last-child { font-size: 18px; font-weight: 600; margin-top: 2px; }

        /* Main Content */
        .container {
            padding: 0 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .day-header {
            margin: 20px 0 10px;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }
        
        .day-header h2 { margin: 0; font-size: 28px; }
        .day-status { font-size: 14px; font-weight: 600; color: var(--accent-blue); }

        /* Subject Cards */
        .subject-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border-left: 6px solid #ccc;
        }

        .subject-card.biology { border-left-color: var(--bio-color); }
        .subject-card.chemistry { border-left-color: var(--chem-color); }
        .subject-card.physics { border-left-color: var(--phys-color); }
        .subject-card.maths { border-left-color: var(--math-color); }
        .subject-card.epq { border-left-color: var(--epq-color); }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .subject-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .subject-badge {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            color: white;
            font-weight: 600;
        }
        .biology .subject-badge { background: var(--bio-color); }
        .chemistry .subject-badge { background: var(--chem-color); }
        .physics .subject-badge { background: var(--phys-color); }
        .maths .subject-badge { background: var(--math-color); }
        .epq .subject-badge { background: var(--epq-color); }

        .topic-name {
            font-size: 15px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #F2F2F7;
        }

        /* Checkbox List */
        .task-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
            color: #C7C7CC;
        }

        /* Custom Checkbox */
        .checkbox {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid #C7C7CC;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .task-item.completed .checkbox {
            background-color: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .checkbox::after {
            content: 'âœ“';
            color: white;
            font-size: 16px;
            font-weight: bold;
            display: none;
        }

        .task-item.completed .checkbox::after {
            display: block;
        }

        .task-text {
            font-size: 16px;
            line-height: 1.4;
        }

        /* Empty State */
        .done-message {
            text-align: center;
            padding: 40px;
            display: none;
        }
        .done-message h3 { font-size: 24px; margin-bottom: 10px; }
        .done-message p { color: var(--text-secondary); }

        /* Progress Bar */
        .progress-container {
            height: 6px;
            background: #E5E5EA;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent-blue);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>



<!-- FIREBASE SCRIPTS -->

    
            <!-- Firebase SDK & App Logic -->
<script type="module">
    // 1. IMPORT FIRESTORE FUNCTIONS
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // 2. YOUR CONFIGURATION
    const firebaseConfig = {
        apiKey: "AIzaSyALPWZE3MlEjy0qhhGl_V8WZxBJyA3Vo68",
        authDomain: "mockexams-f756d.firebaseapp.com",
        projectId: "mockexams-f756d",
        storageBucket: "mockexams-f756d.firebasestorage.app",
        messagingSenderId: "330440451161",
        appId: "1:330440451161:web:69331f774c4db8ef0c3d48",
        measurementId: "G-ERY7L5MJ5N"
    };

    // 3. INITIALIZE FIREBASE & DATABASE
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app); // This was missing in your code

    // --- State & User ---
    let userId = localStorage.getItem('p43_user_id');
    if (!userId) {
        userId = 'student_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('p43_user_id', userId);
    }
    
    let completedItems = {}; 
    let selectedDayIndex = 0;
    const mockStartDate = new Date("2026-02-24");

    // --- Syllabus Content ---
    const syllabus = {
        maths: [ "Algebra & Functions", "Coordinate Geometry", "Exponentials & Logs", "Binomial Expansion", "Sequences & Series", "Trigonometry", "Differentiation", "Integration", "Data Measures", "Probability", "Correlation" ],
        physics: [ "Motion & Graphs", "Energy & Momentum", "Fluids & Solids", "Waves Basics", "Light & Sound", "Circuits & Current", "Resistance & EMF", "Practical Skills" ],
        biology: [ "Chemistry of Life", "Mammalian Transport", "CVD Health", "Membranes", "Proteins & DNA", "Genetics", "Stem Cells", "Practical Bio" ],
        chemistry: [ "Formulae & Moles", "Atomic Structure", "Bonding", "Intro to Organic", "Alkenes", "Energetics", "Intermolecular Forces", "Redox & Groups", "Kinetics", "Alcohols" ]
    };

    // --- Past Paper Rotation ---
    const pastPaperSchedule = [
        { papers: ["Maths P2", "Physics U1", "Chemistry U1"] },
        { papers: ["Biology U1", "Physics U2", "HPAT"] },
        { papers: ["Chemistry U2", "Biology U2", "Physics U3"] },
        { papers: ["Maths P2", "Chemistry U3", "Biology U3"] },
        { papers: ["Physics U1", "Chemistry U1", "Biology U1"] },
        { papers: ["Maths S1", "Physics U2", "Chemistry U2"] },
        { papers: ["Biology U2", "Physics U3", "Maths P2"] },
        { papers: ["Chemistry U3", "Biology U3", "Physics U1"] },
        { papers: ["Maths S1", "Biology U1", "Chemistry U1"] } 
    ];

    // --- Schedule Generator ---
    const schedule = [];
    const startDate = new Date("2026-01-12");
    let mIdx=0, pIdx=0, bIdx=0, cIdx=0;

    for (let i = 0; i < 43; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        
        const dayOfMonth = currentDate.getDate();
        const month = currentDate.toLocaleString('default', { month: 'short' });
        
        let dayData = {
            id: i,
            dateObj: currentDate,
            displayDate: { month, day: dayOfMonth, name: currentDate.toLocaleString('default', { weekday: 'short' }) },
            type: 'revision', 
            subjects: []
        };

        if (i === 42) { 
            dayData.type = 'rest';
        } else if (i >= 33) {
            dayData.type = 'exam';
            const paperSet = pastPaperSchedule[i - 33];
            paperSet.papers.forEach(paperName => {
                dayData.subjects.push({
                    title: paperName,
                    tag: "PAST PAPER",
                    tasks: ["Complete paper (Timed)", "Mark strictly", "Review errors"]
                });
            });
        } else {
            if (i % 2 === 0) {
                dayData.subjects.push({ title: "Mathematics", tag: "P2 / S1", tasks: [`Topic: ${syllabus.maths[mIdx % syllabus.maths.length]}`, "Exam Qs", "Formulas"] });
                dayData.subjects.push({ title: "Physics", tag: "IAL Unit 1/2/3", tasks: [`Topic: ${syllabus.physics[pIdx % syllabus.physics.length]}`, "Definitions", "Calculations"] });
                if(i < 30) { mIdx++; pIdx++; }
            } else {
                dayData.subjects.push({ title: "Biology", tag: "IAL Unit 1/2/3", tasks: [`Topic: ${syllabus.biology[bIdx % syllabus.biology.length]}`, "Active Recall", "Diagrams"] });
                dayData.subjects.push({ title: "Chemistry", tag: "IAL Unit 1/2/3", tasks: [`Topic: ${syllabus.chemistry[cIdx % syllabus.chemistry.length]}`, "Mechanisms", "Definitions"] });
                if(i < 30) { bIdx++; cIdx++; }
            }
        }
        schedule.push(dayData);
    }

    // --- UI Functions ---
    function calculateStats() {
        const today = new Date();
        const diff = Math.ceil((mockStartDate - today) / (1000 * 60 * 60 * 24));
        const daysLeftDisplay = document.getElementById('daysLeftDisplay');
        if(daysLeftDisplay) daysLeftDisplay.textContent = `${Math.max(0, diff)} Days to Mocks`;

        let totalTasks = 0;
        let doneTasks = 0;
        
        schedule.forEach(day => {
            if (day.type === 'rest') return;
            day.subjects.forEach((sub, sIdx) => {
                sub.tasks.forEach((_, tIdx) => {
                    totalTasks++;
                    if (completedItems[`d${day.id}_s${sIdx}_t${tIdx}`]) doneTasks++;
                });
            });
        });

        const pct = totalTasks === 0 ? 0 : (doneTasks / totalTasks) * 100;
        const progressBar = document.getElementById('overallProgressBar');
        if(progressBar) progressBar.style.width = `${pct}%`;
    }

    function renderScroller() {
        const scroller = document.getElementById('dateScroller');
        scroller.innerHTML = '';
        
        const todayStr = new Date().toDateString();
        const todayIdx = schedule.findIndex(d => d.dateObj.toDateString() === todayStr);
        if (selectedDayIndex === 0 && todayIdx !== -1) selectedDayIndex = todayIdx;

        schedule.forEach((day, idx) => {
            const el = document.createElement('div');
            el.className = `date-chip ${idx === selectedDayIndex ? 'active' : ''} ${day.type === 'rest' ? 'rest-day-marker' : ''}`;
            el.innerHTML = `${day.displayDate.month} ${day.displayDate.day}<span>${day.displayDate.name}</span>`;
            el.onclick = () => {
                document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
                el.classList.add('active');
                selectedDayIndex = idx;
                renderDay(idx);
                el.scrollIntoView({ behavior: 'smooth', inline: 'center' });
            };
            scroller.appendChild(el);
        });
        
        setTimeout(() => {
            const active = document.querySelector('.date-chip.active');
            if(active) active.scrollIntoView({ inline: 'center' });
        }, 100);
    }

    function renderDay(idx) {
        const day = schedule[idx];
        const container = document.getElementById('scheduleContent');
        container.innerHTML = '';

        const title = document.getElementById('currentDateTitle');
        const subtitle = document.getElementById('currentFocusSubtitle');
        
        const isToday = day.dateObj.toDateString() === new Date().toDateString();
        title.textContent = isToday ? "Today" : `${day.displayDate.name}, ${day.displayDate.month} ${day.displayDate.day}`;

        if (day.type === 'rest') {
            subtitle.textContent = "Recharge your mind.";
            container.innerHTML = `<div class="card rest-mode"><span class="rest-icon">ðŸ§˜</span><div class="rest-title">Rest Day</div><div class="rest-desc">No studying today.</div></div>`;
            return;
        }

        subtitle.textContent = day.type === 'exam' ? "Past Paper Mode." : "Deep Focus Revision.";

        const card = document.createElement('div');
        card.className = 'card';
        
        day.subjects.forEach((sub, sIdx) => {
            const row = document.createElement('div');
            row.className = 'subject-row';
            let html = `<div class="subject-header"><div class="sub-name">${sub.title}</div><span class="paper-tag" style="background:${day.type==='exam' ? '#FF2D55' : '#000'}">${sub.tag}</span></div>`;

            sub.tasks.forEach((task, tIdx) => {
                const itemId = `d${day.id}_s${sIdx}_t${tIdx}`;
                const checked = completedItems[itemId] ? 'checked' : '';
                // Note: We call window.toggle here, which we define below
                html += `<div class="checklist-item ${checked}" id="${itemId}" onclick="window.toggle('${itemId}')"><div class="checkbox"></div><div class="text">${task}</div></div>`;
            });

            row.innerHTML = html;
            card.appendChild(row);
        });
        container.appendChild(card);
    }

    // --- Actions ---
    // We attach this to 'window' so the HTML onclick="" can see it
    window.toggle = (id) => {
        // 1. Optimistic UI update (Immediate)
        const isChecked = !completedItems[id];
        completedItems[id] = isChecked;
        
        const el = document.getElementById(id);
        if(el) {
            if(isChecked) el.classList.add('checked');
            else el.classList.remove('checked');
        }
        calculateStats();
        
        // 2. Set Status immediately to "Saving"
        const statusEl = document.getElementById('dbStatus');
        statusEl.textContent = "Saving...";
        statusEl.style.color = "#86868b";

        // 3. Fire and forget to Cloud Firestore
        const docRef = doc(db, "users", userId);
        setDoc(docRef, { progress: completedItems }, { merge: true })
            .catch(err => {
                console.error("Error writing document: ", err);
                statusEl.textContent = "Error saving!";
                statusEl.style.color = "red";
            });
    };

    // --- Init ---
    async function init() {
        renderScroller();
        renderDay(selectedDayIndex);
        calculateStats();

        const docRef = doc(db, "users", userId);
        
        // Listen to Cloud Firestore
        onSnapshot(docRef, (snap) => {
            const source = snap.metadata.hasPendingWrites ? "Local" : "Server";
            
            if (snap.exists()) {
                const data = snap.data();
                // Merge data carefully
                completedItems = data.progress || {};
                
                // Re-render
                renderDay(selectedDayIndex); 
                calculateStats();
                
                const statusEl = document.getElementById('dbStatus');
                if (source === "Local") {
                    statusEl.textContent = "Unsynced changes...";
                } else {
                    statusEl.textContent = "All changes saved";
                    statusEl.style.color = "#34c759";
                }
            }
        });
    }

    // Start
    init();
</script>


</body>
</html>
